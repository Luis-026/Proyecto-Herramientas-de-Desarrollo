<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Ventas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #2563eb;
            --light-blue: #dbeafe;
            --cream: #fef7ed;
            --light-cream: #fffbf5;
            --dark-text: #1f2937;
            --gray-text: #6b7280;
            --light-gray: #f9fafb;
            --border-color: #e5e7eb;
            --white: #ffffff;
            --yellow: #fbbf24;
            --green: #10b981;
            --red: #ef4444;
        }

        body {
            background-color: var(--light-cream);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--dark-text);
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .main-card {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: var(--cream);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--yellow);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 2rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 1rem;
            align-items: end;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--light-gray);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            color: var(--gray-text);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-control, .form-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            background: var(--white);
            color: var(--dark-text);
            transition: border-color 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-add {
            background: var(--yellow);
            color: var(--dark-text);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-add:hover {
            background: #f59e0b;
        }

        .products-section {
            margin-top: 2rem;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .products-table th {
            background: var(--light-gray);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark-text);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .products-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--dark-text);
        }

        .products-table tr:hover {
            background: var(--light-cream);
        }

        .btn-remove {
            background: var(--yellow);
            color: var(--dark-text);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-remove:hover {
            background: #f59e0b;
        }

        .total-section {
            text-align: right;
            margin-bottom: 2rem;
        }

        .total-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 1.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn-clear {
            background: var(--red);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-clear:hover {
            background: #dc2626;
        }

        .btn-process {
            background: var(--green);
            color: var(--white);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-process:hover {
            background: #059669;
        }

        .btn-back {
            background: var(--light-blue);
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: auto;
        }

        .btn-back:hover {
            background: #bfdbfe;
            text-decoration: none;
            color: var(--primary-blue);
        }

        .empty-cart {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray-text);
        }

        .empty-cart i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .products-table {
                font-size: 0.85rem;
            }

            .products-table th,
            .products-table td {
                padding: 0.75rem 0.5rem;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .btn-back {
                margin-right: 0;
                margin-bottom: 1rem;
            }
        }

        .product-item {
            display: none;
        }

        .cart-item {
            background: var(--white);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-card">
        <div class="card-header">
            <h1 class="page-title">
                <i class="fas fa-shopping-cart"></i>
                Simular Venta
            </h1>
        </div>

        <div class="card-body">
            <div class="section-title">
                <i class="fas fa-plus-circle"></i>
                Añadir Producto a la Venta
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Buscar y seleccionar un producto...</label>
                    <select class="form-select" id="productoSelect">
                        <option value="">Seleccione un producto</option>
                        <option th:each="p : ${productos}"
                                th:value="${p.id}"
                                th:text="${p.nombre}"
                                th:data-precio="${p.precio}"
                                th:data-stock="${p.stock}"></option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Cantidad</label>
                    <input type="number" class="form-control" id="cantidadInput" value="1" min="1" style="width: 80px;">
                </div>

                <button type="button" class="btn-add" onclick="agregarAlCarrito()">
                    <i class="fas fa-plus"></i>
                    Añadir al Carrito
                </button>
            </div>

            <div class="products-section">
                <div class="section-title">
                    <i class="fas fa-shopping-basket"></i>
                    Productos en el Carrito:
                </div>

                <div id="cartContainer">
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p><strong>Tu carrito está vacío</strong></p>
                        <p>Añade productos para comenzar una venta</p>
                    </div>
                </div>

                <table class="products-table" id="cartTable" style="display: none;">
                    <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                        <th>Acción</th>
                    </tr>
                    </thead>
                    <tbody id="cartItems">
                    </tbody>
                </table>

                <div class="total-section" id="totalSection" style="display: none;">
                    <div class="total-amount">
                        Total Venta: $<span id="totalAmount">0.00</span>
                    </div>

                    <div class="action-buttons">
                        <a href="/principal" class="btn-back">
                            <i class="fas fa-arrow-left"></i>
                            Volver
                        </a>
                        <button type="button" class="btn-clear" onclick="limpiarCarrito()">
                            <i class="fas fa-trash"></i>
                            Limpiar Carrito
                        </button>
                        <button type="button" class="btn-process" onclick="realizarVenta()">
                            <i class="fas fa-credit-card"></i>
                            Realizar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let carrito = [];
    let contadorId = 1;

    function agregarAlCarrito() {
        const select = document.getElementById('productoSelect');
        const cantidad = parseInt(document.getElementById('cantidadInput').value);

        if (!select.value) {
            alert('Por favor selecciona un producto');
            return;
        }

        if (!cantidad || cantidad < 1) {
            alert('Por favor ingresa una cantidad válida');
            return;
        }

        const option = select.options[select.selectedIndex];
        const productoId = select.value;
        const nombreProducto = option.text;
        const precio = parseFloat(option.dataset.precio);
        const stock = parseInt(option.dataset.stock);

        // Verificar stock
        if (cantidad > stock) {
            alert(`Stock insuficiente. Disponible: ${stock} unidades`);
            return;
        }

        // Verificar si el producto ya está en el carrito
        const productoExistente = carrito.find(item => item.productoId === productoId);

        if (productoExistente) {
            const nuevaCantidad = productoExistente.cantidad + cantidad;
            if (nuevaCantidad > stock) {
                alert(`Stock insuficiente. Ya tienes ${productoExistente.cantidad} en el carrito. Máximo disponible: ${stock}`);
                return;
            }
            productoExistente.cantidad = nuevaCantidad;
            productoExistente.subtotal = productoExistente.cantidad * precio;
        } else {
            carrito.push({
                id: contadorId++,
                productoId: productoId,
                nombre: nombreProducto,
                cantidad: cantidad,
                precio: precio,
                subtotal: cantidad * precio
            });
        }

        actualizarCarrito();

        // Limpiar formulario
        select.value = '';
        document.getElementById('cantidadInput').value = 1;
    }

    function removerDelCarrito(id) {
        carrito = carrito.filter(item => item.id !== id);
        actualizarCarrito();
    }

    function actualizarCarrito() {
        const cartContainer = document.getElementById('cartContainer');
        const cartTable = document.getElementById('cartTable');
        const cartItems = document.getElementById('cartItems');
        const totalSection = document.getElementById('totalSection');
        const totalAmount = document.getElementById('totalAmount');

        if (carrito.length === 0) {
            cartContainer.style.display = 'block';
            cartTable.style.display = 'none';
            totalSection.style.display = 'none';
            return;
        }

        cartContainer.style.display = 'none';
        cartTable.style.display = 'table';
        totalSection.style.display = 'block';

        // Limpiar tabla
        cartItems.innerHTML = '';

        // Agregar items
        let total = 0;
        carrito.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.nombre}</td>
                <td>${item.cantidad}</td>
                <td>$${item.precio.toFixed(2)}</td>
                <td>$${item.subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn-remove" onclick="removerDelCarrito(${item.id})">
                        Quitar
                    </button>
                </td>
            `;
            cartItems.appendChild(row);
            total += item.subtotal;
        });

        totalAmount.textContent = total.toFixed(2);
    }

    function limpiarCarrito() {
        if (carrito.length === 0) return;

        if (confirm('¿Estás seguro de que quieres limpiar el carrito?')) {
            carrito = [];
            actualizarCarrito();
        }
    }

    function realizarVenta() {
        if (carrito.length === 0) {
            alert('El carrito está vacío');
            return;
        }

        const total = carrito.reduce((sum, item) => sum + item.subtotal, 0);
        const resumen = carrito.map(item =>
            `${item.nombre} (${item.cantidad} x $${item.precio.toFixed(2)})`
        ).join('\n');

        const confirmacion = confirm(
            `¿Confirmar venta?\n\n${resumen}\n\nTotal: $${total.toFixed(2)}`
        );

        if (confirmacion) {
            // Procesar cada item del carrito
            let ventasCompletas = 0;

            carrito.forEach(item => {
                // Crear formulario para cada venta
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/ventas/realizar';
                form.style.display = 'none';

                const inputProducto = document.createElement('input');
                inputProducto.name = 'productoId';
                inputProducto.value = item.productoId;
                form.appendChild(inputProducto);

                const inputCantidad = document.createElement('input');
                inputCantidad.name = 'cantidad';
                inputCantidad.value = item.cantidad;
                form.appendChild(inputCantidad);

                document.body.appendChild(form);
                form.submit();
            });
        }
    }
</script>
</body>
</html>